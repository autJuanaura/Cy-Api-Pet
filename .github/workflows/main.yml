name: Api PET CI
on:
  workflow_dispatch:
  push:
    branches:
      - 'master'

jobs:
  cypress-e2e-api:
    runs-on: ubuntu-latest
    name: Run Cypress E2E Tests
    container:
      image: cypress/browsers:node16.16.0-chrome107-ff107
    steps:
      - name: Checkout code repository ğŸ“
        uses: actions/checkout@v3
      - name: Install Cypress ğŸ’»
        run: npm install cypress

      - name: Cache Cypress dependencies ğŸ’¾
        uses: actions/cache@v3
        id: cache-cypress-deps
        with:
          path: ~/.npm
          key: ${{ runner.os }}-cypress-deps-${{ matrix.cypress }}
      - name: Cache Cypress binary ğŸ’»
        uses: actions/cache@v3
        id: cache-cypress-binary
        with:
          path: ~/.cache/Cypress
          key: ${{ runner.os }}-cypress-binary-${{ matrix.cypress }}
      - name: Restore Cypress dependencies ğŸ’¾
        uses: actions/cache@v3
        id: restore-cypress-deps
        with:
          path: ~/.npm
          key: ${{ runner.os }}-cypress-deps-${{ matrix.cypress }}
      - name: Restore Cypress binary ğŸ’»
        uses: actions/cache@v3
        id: restore-cypress-binary
        with:
          path: ~/.cache/Cypress
          key: ${{ runner.os }}-cypress-binary-${{ matrix.cypress }}

      - name: Run Cypress tests with Chrome ğŸš€
        uses: cypress-io/github-action@v5
        continue-on-error: true
        with:
          browser: chrome
        env:
          CYPRESS_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Run Cypress tests with Firefox ğŸš€
        uses: cypress-io/github-action@v5
        continue-on-error: true
        with:
          browser: firefox
        env:
          CYPRESS_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Run Cypress tests in parallel ğŸš€
        uses: cypress-io/github-action@v5
        continue-on-error: true
        with:
          parallel: true
        env:
          CYPRESS_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Run Cypress dashboard ğŸ“Š
        uses: cypress-io/github-action@v5
        with:
          dashboard: true
        env:
          CYPRESS_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Run Code Analysis ğŸ”
        uses: github/codeql-action/analyze@v2
        with:
          languages: 'javascript'
          queries: 'security-extended'
          format: 'html'
          output: 'code-analysis-report.html'

      - name: Merge test results into one ğŸ“Š
        run: npm run report:merge

      - name: Generate HTML report ğŸ“„
        run: npm run report:generate

      - name: Publish report to GitHub Pages ğŸ“¢
        uses: peaceiris/actions-